steps:
  - bash: echo "##vso[task.prependpath]$CONDA/bin"
    displayName: Add conda to PATH

  - script: |
      conda create -n py -c conda-forge python=$python_version compilers ninja make cmake
      conda activate py
      pip install numpy$NUMPY_VERSION;
      pip install -e .[tests]
      pip install codecov
    displayName: Install package

  - script: |
      conda activate py
      pytest --pyargs sparse
    displayName: Run tests

  - script: |
      conda activate py
      codecov
    displayName: Upload coverage to CodeCov
    condition: succeededOrFailed()

  - task: PublishTestResults@2
    condition: always()
    inputs:
      testResultsFiles: "$(System.DefaultWorkingDirectory)/**/test-*.xml"
      testRunTitle: "Publish test results"
    condition: succeededOrFailed()

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/coverage.xml"
    condition: succeededOrFailed()
